#!/bin/sh -e
#
# Description: Desktop selection, configures x-session-manager and default display manager
#              Must run after 1140-xserver-xorg from live-config
#

for _PARAMETER in $(cat /proc/cmdline)
do
	case "${_PARAMETER}" in
		desktop=*)
			LERNSTICK_DESKTOP="${_PARAMETER#*desktop=}"
			;;
	esac
done

echo "selected desktop: \"${LERNSTICK_DESKTOP}\""

case "${LERNSTICK_DESKTOP}" in
	kde)
		_SESSION_MANAGER="/usr/bin/startkde"
		_DISPLAY_MANAGER="/usr/bin/sddm"
		_SERVICE_NAME="sddm"
		sed -i 's/Session=.*/Session=plasma.desktop/' /etc/sddm.conf
		;;

	gnome)
		_SESSION_MANAGER="/usr/bin/gnome-session"
		_DISPLAY_MANAGER="/usr/sbin/gdm3"
		_SERVICE_NAME="gdm3"
		;;

	cinnamon)
		_SESSION_MANAGER="/usr/bin/cinnamon-session"
		_DISPLAY_MANAGER="/usr/sbin/gdm3"
		_SERVICE_NAME="gdm3"
		;;

	mate)
		_SESSION_MANAGER="/usr/bin/mate-session"
		_DISPLAY_MANAGER="/usr/sbin/gdm3"
		_SERVICE_NAME="gdm3"
		;;

	xfce)
		_SESSION_MANAGER="/usr/bin/startxfce4"
		_DISPLAY_MANAGER="/usr/sbin/gdm3"
		_SERVICE_NAME="gdm3"
		;;

	lxde)
		_SESSION_MANAGER="/usr/bin/lxsession"
		_DISPLAY_MANAGER="/usr/sbin/gdm3"
		_SERVICE_NAME="gdm3"
		# The xsession name is diffrent from our flag
		LERNSTICK_DESKTOP="LXDE"
		;;

	enlightenment)
		# there is no alternatives option for enlightenment...
		_DISPLAY_MANAGER="/usr/bin/sddm"
		_SERVICE_NAME="sddm"
		sed -i 's/Session=.*/Session=enlightenment.desktop/' /etc/sddm.conf
		;;

	no)
		_DISPLAY_MANAGER=""
		;;
esac

PREVIOUS_SESSION_MANAGER="$(update-alternatives --query x-session-manager | grep ^Value: | cut -f 2 -d ' ')"
echo "previous session manager: $PREVIOUS_SESSION_MANAGER"
echo "new session manager: $_SESSION_MANAGER"

if [ -n "${_SESSION_MANAGER}" -a "$PREVIOUS_SESSION_MANAGER" != "${_SESSION_MANAGER}" ]
then
	update-alternatives --set x-session-manager "${_SESSION_MANAGER}"
	sed -i "s/XSession=.*/XSession=${LERNSTICK_DESKTOP}/g" /var/lib/AccountsService/users/user
fi

# This service file is not needed and should not be there
rm -f /etc/systemd/system/display-manager.service

if ! grep -q "^${_DISPLAY_MANAGER}$" /etc/X11/default-display-manager
then
	# The user changed the default display manager, update its file.
	echo "${_DISPLAY_MANAGER}" > /etc/X11/default-display-manager

	# If there is no display manager drop to shell
	if [ -z "${_DISPLAY_MANAGER}" ]
	then
		systemctl --no-block isolate multi-user.target 
	fi
fi

